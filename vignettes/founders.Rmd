---
title: "AlphaPart: Accounting for non-zero mean and structure in founders"
author: "Rosalind Craddock and Gregor Gorjanc"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Founders}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

TODO: Double check AlphaPart and genetic groups #7 <https://github.com/AlphaGenes/AlphaPart/issues/7>

## Introduction

-   TODO: Cite Ros' paper on partitioning with non-zero mean in founders and metafounders #42 <https://github.com/AlphaGenes/AlphaPart/issues/42>

This vignette has two objectives. First, through a simple example, demonstrate the different approaches possible by the user for the partitioning of genetic trends using the AlphaPart R package. Second, through a more complex example, explain the different approaches and consequences for the interpretation of results. Thus, within we will clarify the reasoning behind either centering or including unknown parent groups in the partitioning of genetic values to account for non-zero mean in the founders.

## Load packages

```{r}
rm(list=ls())
library(AlphaPart)
```

## Create pedigree

We will use a simple seven individual pedigree with one trait. These will be referred to as genetic values, however, they could be breeding values, genotypes, or any other additive genetic estimate.

```{r}
ped <- data.frame(
    id = c(1:7),
    fid = c(0, 0, 0, 0, 1, 3, 6),
    mid = c( 0, 0, 0, 0, 2, 4, 5),
    sex = c("male", "female", "male", "female", "female", "male", "male"),
    gen = c(1, 1, 1, 1, 2, 2, 3),
    trt1=c(-6.25, -5.25, 0.75, 10.75, -2.25, 0.75, 3.75))

print(ped)
```

## When founders have mean genetic value equal to zero

Here, individuals 1 to 4 are the founders with no known parents (fid and mid are equal to 0). The mean genetic value of the founders for `trt1` is 0 which aligns with the model assumption of AlphaPart. Thus, we can directly use the pedigree above for partitioning of `trt1` genetic values by sex without any modifications.

```{r}
mean(ped$trt1[ped$fid==0 & ped$mid==0])
```

```{r}
part <- AlphaPart(x = ped, colId = "id", colFid = "fid", colMid = "mid", colPath = "sex", colBV = "trt1")
# Print dataframe of results
part[["trt1"]]
# Summarise by generation for plotting
partSum <- summary(part, by = "gen")
plot(partSum)
```

## When founders have non-zero mean genetic value

But, what if the mean genetic value of the founders is not zero? Consider the same pedigree below with new trait values such that the mean genetic value of the founders is not 0, but 11.25.

```{r}
ped$trt1 <- c(5, 6, 12, 22, 9, 12, 15)

mean(ped$trt1[ped$fid==0 & ped$mid==0])

```

Then run through AlphaPart as before.

```{r}
part <- AlphaPart(x = ped, colId = "id", colFid = "fid", colMid = "mid", colPath = "sex", colBV = "trt1")
# Print dataframe of results
part[["trt1"]]
# Summarise by generation for plotting
partSum <- summary(part, by = "gen")
plot(partSum)
```

As noted, this produces a warning since the founders genetic value for trait 1 is not zero. However, results are still produced. Whether they are meaningful depends on the specific model and assumptions used in estimating the genetic values. In this case, however, they are not correct.

To obtain correct results, we need to either center the genetic values such that the mean of the founders genetic value (`trt1`) is zero or include unknown parent groups in the pedigree.

### Centering genetic values

First, we will center the genetic values by subtracting the mean of the founders from all individuals.

```{r}
ped$trt1Centered <- ped$trt1 - mean(ped$trt1[ped$fid==0 & ped$mid==0])
mean(ped$trt1Centered[ped$fid==0 & ped$mid==0])
```

Now we can run AlphaPart as before.

```{r}
part <- AlphaPart(x = ped, colId = "id", colFid = "fid", colMid = "mid", colPath = "sex", colBV = "trt1Centered")
# Print dataframe of results
part[["trt1"]]
# Summarise by generation for plotting
partSum <- summary(part, by = "gen")
plot(partSum)
```

As we can see from the graph above, the partitioned genetic trends are now relative to the base population. Thus, describing the within pedigree partition (as the data is limited to). However, the 'Sum' line now represents the centered genetic trend, not the actual genetic trend. Hence, the inclusion of unknown parent groups may be preferred.

### Including unknown parent groups

By including unknown parent groups, the model considers the baseline contribution from the missing ancestry through additional partitions. Where multiple unknown parent groups are assigned, there will be an additional partition for each. A non-zero mean in the genetic values of the founders can be handled by assigning one (or more) unknown parent group to all individuals with unknown parents with a genetic value equal to their mean. However, this requires specific modification to the pedigree to produce results without error. First, we will show what **not** to do, then we will show the correct approach.

Within the pedigree, we will assign one unknown parent group to all founding individuals.

```{r}
ped$fid[ped$fid == 0] <- "UPG1"
ped$mid[ped$mid == 0] <- "UPG1"

ped
```

Then we will run AlphaPart as before.

```{r}
part <- AlphaPart(x = ped, colId = "id", colFid = "fid", colMid = "mid", colPath = "sex", colBV = "trt1")
```

This has produced an error since when recoding the pedigree, the `UPG1` is replaced with 0 as has no matching record in `ped$id`. To correctly include unknown parent groups, we need to add records for them in the pedigree with appropriate genetic values. Essentially including them as pseudo-individuals through the Quass-Pollak transformation (Quass and Pollak, 1981).

Here, we will add a record for `UPG1` with a genetic value equal to the mean of the founders and allocate its own group for partitioning. Note in `ped$Sex`, we assign `UPG1` to identify the path for the additional partition when including an unknown parent group.

```{r}
upg <- c("UPG1", 0, 0, "UPG1", 0, mean(ped$trt1[ped$fid=="UPG1" & ped$mid=="UPG1"]), NA)
ped <- rbind(upg, ped)
# Ensure correct data types
ped$trt1 <- as.numeric(ped$trt1)
ped
```

Now we can run AlphaPart as before.

```{r}
part <- AlphaPart(x = ped, colId = "id", colFid = "fid", colMid = "mid", colPath = "sex", colBV = "trt1")
# Print dataframe of results
part[["trt1"]]
# Summarise by generation for plotting
partSum <- summary(part, by = "gen")
plot(partSum, col = c("green", "red", "blue", "black"))
```

This plots differs to all previous for two reasons. First, we have an additional partition for the unknown parent group (`UPG1` in green). Second, because of the inclusion of the unknown parent group in the pedigree in generation zero, the x-axis range from 0 to 3 rather than 1 to 3.

When we only plot from 1 to 3, the female (red) and male (blue) partition trends match those observed when centering the genetic values. However the sum (black) line now represents the actual genetic trend rather than the centered genetic trend.

```{r}
partSum[["trt1"]] <- partSum[["trt1"]][partSum[["trt1"]]$gen !=0, ]
plot(partSum, col = c("green", "red", "blue", "black"))
```

### Including multiple unknown parent groups

For completeness, we will use the same example to demonstrate how to include two unknown parent groups. The asigned genetic values for each unnown parent group will be equal to the mean genetic value of their respective founders. In this case `UPG1`'s genetic value will be the mean of individuals 1 and 2, `UPG2`'s genetic value will be the mean of individuals 3 and 4.

```{r}
ped <- ped[-1, ] # Remove previous UPG1 record
ped$fid[ped$id %in% c(3,4)] <- "UPG2"
ped$mid[ped$id %in% c(3,4)] <- "UPG2"
upg1 <- c("UPG1", 0, 0, "UPG1", 0, mean(ped$trt1[ped$id %in% c(1,2)]), NA)
upg2 <- c("UPG2", 0, 0, "UPG2", 0, mean(ped$trt1[ped$id %in% c(3,4)]), NA)
ped <- rbind(upg1, upg2, ped)
ped$trt1 <- as.numeric(ped$trt1)

ped
```

Now we can run through AlphaPart

```{r}
part <- AlphaPart(x = ped, colId = "id", colFid = "fid", colMid = "mid", colPath = "sex", colBV = "trt1")
# Print dataframe of results
part[["trt1"]]
# Summarise by generation for plotting
partSum <- summary(part, by = "gen")
plot(partSum, col = c("green", "darkgreen", "red", "blue", "black"))
```
### Including multiple traits with unknown parent groups
The above examples demonstrates the inclusion of unknown parent groups with a single trait. Yet, AlphaPart allows for multiple traits to be partitioned simultaneously. For clarity, we will demonstrate the inclusion of unknown parent groups with two traits.
```{r}
ped$trt2 <- c(NA, NA, 100, 50, 10, 40, 98, 20, 71)
ped$trt2[ped$id %in% c("UPG1")] <- mean(ped$trt2[ped$id %in% c(1,2)])
ped$trt2[ped$id %in% c("UPG2")] <- mean(ped$trt2[ped$id %in% c(3,4)])
ped
```
Now we can run through AlphaPart

```{r}
part <- AlphaPart(x = ped, colId = "id", colFid = "fid", colMid = "mid", colPath = "sex", colBV = c("trt1", "trt2"))
# Print dataframe of trt2 results (trt1 will be the same as previous example)
part[["trt2"]]
# Summarise by generation for plotting
partSum <- summary(part, by = "gen")
plot(partSum, col = c("green", "darkgreen", "red", "blue", "black"))
```
And if we plot from generation 1 to 3 only.
```{r}
partSum[["trt1"]] <- partSum[["trt1"]][partSum[["trt1"]]$gen !=0, ]
partSum[["trt2"]] <- partSum[["trt2"]][partSum[["trt2"]]$gen !=0, ]
plot(partSum, col = c("green", "darkgreen", "red", "blue", "black"))

```

## Non-zero mean in genetic values of founders in complex examples

The above toy example demonstrates the different approaches possible for the user and how to implement them when the founders genetic values have non-zero means. However, as the pedigree is well balanced, the observed difference is minimal. In more complex pedigrees, the difference will be more pronounced and important. Below, we will demonstrate this with complex examples and focusing more on the interpretation of the results.

-   TODO: More complex example(s)

## References

-   TODO: Cite Ros' paper on partitioning with non-zero mean in founders and metafounders #42 <https://github.com/AlphaGenes/AlphaPart/issues/42>
